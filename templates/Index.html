<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <title>Email Inspector</title>
  </head>
  <body>
  <div class="app">
    <header class="topbar">
      <div class="brand">Email Inspector</div>
      <div class="top-actions">
        <a class="top-btn" href="downloadGuide.html">How to export emails</a>
      </div>
    </header>

    <main class="chat-panel">
      <div class="chat-window" id="chatWindow" role="log" aria-live="polite">
        <div class="message assistant centered">
          <div class="meta">Phishing Detector</div>
          <div>Hello, give me an email and I will parse its metadata!</div>
        </div>
      </div>

      <section class="forward-card" aria-label="Forward info">
        <div class="text">You can also forward the email to <strong>fakeemail@ncsu.edu</strong> and receive a quick reply!</div>
      </section>

      <section class="upload-card" aria-label="Upload email">
        <div class="meta">Upload email file</div>
        <div class="upload-row">
            <label class="file-chooser" for="fileInput">Choose file
              <input id="fileInput" type="file" name="fileInput" accept=".eml,.msg">
            </label>
        </div>
        <div class="hint" style="color:var(--muted);font-size:13px">Accepted: .eml, .msg â€” upload exported messages for analysis.</div>
        <div id="output" class="hint" style="color:var(--muted);font-size:15px"></div>
      </section>
    </main>
  </div>

    <div id="judgementBox" class="judgement-box hidden" role="status" aria-live="polite"></div>


  <script type="module">

  fileInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
    const response = await fetch('/upload', {
      method: 'POST',
      body: formData
    });

      const result = await response.json();
      let judgementOutput = "FAULTS : \n";
      if(result.judgement.indexOf("Mismatched addresses") != -1){
        judgementOutput += `Return address does not match the 'from' address, `;
      }
      if(result.judgement.indexOf("Phishing email") != -1){
        judgementOutput += "contains a known malicious url, ";
      }
      if(result.judgement.indexOf("Failed spf") != -1){
        judgementOutput += "email did not come from a recognized sender's domain, ";
      }
      if(result.judgement.indexOf("Failed dmarc") != -1){
        judgementOutput += "failed dmarc security checks, ";
      }
      if(result.judgement.indexOf("Failed dkim") != -1){
        judgementOutput += "invalid digital signature, ";
      }
      if(result.judgement.indexOf("Unknown domain") != -1){
        judgementOutput += "Unknown domain, ";
      }
  const jb = document.getElementById("judgementBox");
  jb.innerText = judgementOutput;
  jb.classList.remove('hidden');
      console.log('Server response:', result);
    } catch (err) {
      console.error('Error uploading file:', err);
    }
    
  });

  </script>
  </body>
</html>
